name: 'Terraform Apply - Multiple Workspaces'
description: 'Runs a terraform apply for a repo with a multiple workspaces.'
inputs:
  ssh_key:
    description: '[secret] GitHub SSH Key for pulling repo.'
    required: true
  terraform_version:
    description: '[decimal] (i.e. 1.0.11) Terraform version to use.'
    required: true
  terraform_workspace:
    description: '[string] (i.e. $branchName/stage/prod) TF Workspace.'
    required: false
    default: default
  terraform_targets:
    description: "[string] (i.e aws_ecr_repository.name module.name) Terraform resources to target during the plan. Seperate multiple resources with a space ' ' . See https://developer.hashicorp.com/terraform/tutorials/state/resource-targeting"
    required: false
    default: ""
  use_shared_workspaces:
    description: '[bool] (i.e. true/false) Whether or not to use shared workspaces.'
    required: false
    default: "true"

runs:
  using: "composite"
  steps:
    - name: Validate Inputs
      env:
        SSH_KEY: ${{ inputs.ssh_key }}
        TERRAFORM_VERSION: ${{ inputs.terraform_version }}
        TERRAFORM_WORKSPACE: ${{ inputs.terraform_workspace }}
      run: |
        cd ${{ github.action_path }}
        source ../../shell-scripts/input-validator.sh

        declare -A inputs
        inputs[ssh_key]="$SSH_KEY"
        inputs[terraform_version]="$TERRAFORM_VERSION"
        inputs[terraform_workspace]="$TERRAFORM_WORKSPACE"

        validateInput inputs
      shell: bash
    - name: Install SSH Key
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ inputs.ssh_key }}
    # - name: Pull
    #   uses: actions/checkout@v4
    #   with:
    #     ref: ${{ github.event.deployment.ref }}
    #     lfs: true
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ env.GH_AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ env.GH_AWS_SECRET_KEY }}
        aws-region: us-west-2
    - name: HashiCorp - Setup Terraform
      uses: hashicorp/setup-terraform@v1.2.1
      with:
        terraform_version: ${{ inputs.terraform_version }}
    - name: TF Apply
      working-directory: ./infrastructure
      run: |
        if [ "${{ inputs.use_shared_workspaces }}" == "false" ] || [ "${{ inputs.terraform_workspace }}" == "prod" ] || [ "${{ inputs.terraform_workspace }}" == "stage" ] || [ "${{ inputs.terraform_workspace }}" == "qa" ] ; then
          shared_workspace=${{ inputs.terraform_workspace }}
        else
          shared_workspace=default
        fi

        if [ ! -z "${{ inputs.terraform_targets }}" -a "${{ inputs.terraform_targets }}" != " " ]; then
          targets_option="-target=$(echo "${{ inputs.terraform_targets }}" | sed -r 's/[ ]+/ -target=/g')"
        fi

        terraform version
        terraform init -lock=false -input=false
        terraform validate
        terraform workspace select ${{ inputs.terraform_workspace }} || terraform workspace new ${{ inputs.terraform_workspace }}
        terraform workspace show
        terraform plan $(printf -- '-var-file=%s ' vars/$shared_workspace*.tfvars) -lock=true -lock-timeout=0s -input=false -out=tfplan $targets_option
        terraform apply -lock=true -lock-timeout=0s -input=false tfplan
      shell: bash
